<?php
// Get all active currencies
$currencies = getAllCurrencies(true);

// Get currency pairs with valid exchange rates
$db = Database::getInstance();
$exchangeRates = $db->getRows(
    "SELECT er.*, 
     fc.name as from_currency_name, fc.display_name as from_display_name,
     tc.name as to_currency_name, tc.display_name as to_display_name
     FROM exchange_rates er
     JOIN currencies fc ON er.from_currency = fc.code
     JOIN currencies tc ON er.to_currency = tc.code
     WHERE er.status = 'active' AND fc.status = 'active' AND tc.status = 'active'"
);

// Create exchange rates array for JavaScript
$exchangeRatesJS = [];
foreach ($exchangeRates as $rate) {
    $exchangeRatesJS["{$rate['from_currency']}-{$rate['to_currency']}"] = (float)$rate['rate'];
}

// Get operator contact info
$operatorContact = [
    'whatsapp' => getSetting('contact_whatsapp', '8801869838872'),
    'phone' => getSetting('contact_phone', '+8801869838872'),
    'email' => getSetting('contact_email', 'support@exchangebridge.com')
];

// Get site settings
$siteName = getSetting('site_name', 'Exchange Bridge');
$siteTagline = getSetting('site_tagline', 'Exchange Taka Globally');
$contactEmail = getSetting('contact_email', 'info@exchangebridge.com');
$contactPhone = getSetting('contact_phone', '+8801869838872');

// Get all wizard settings from admin panel
$wizardSettings = [
    // Step 1 - Exchange Form Settings
    'wizard_title' => getSetting('wizard_title', 'Fast Exchange in Minutes'),
    'wizard_subtitle' => getSetting('wizard_subtitle', 'Minimum Buy-Sell $1 Dollar'),
    'wizard_heading' => getSetting('wizard_heading', 'Start Exchange'),
    'wizard_footer_text' => getSetting('wizard_footer_text', 'When ordering, give your mobile phone number and when you buy dollars from us, you must send money from your bKash/rocket/cash number. If you send money from other number, your order will be canceled and the rest of the money will be refunded.'),
    'send_section_label' => getSetting('send_section_label', 'SEND'),
    'receive_section_label' => getSetting('receive_section_label', 'RECEIVE'),
    'currency_select_label' => getSetting('currency_select_label', 'Select Exchange Currency'),
    'amount_input_label' => getSetting('amount_input_label', 'Enter Exchange Amount'),
    'receive_amount_label' => getSetting('receive_amount_label', 'You\'ll Get this Amount'),
    'continue_button_text' => getSetting('continue_button_text', 'Continue to Next Step'),
    
    // Step 2 - Contact Information Settings
    'contact_step_title' => getSetting('contact_step_title', 'Provide Your Contact Details'),
    'name_field_label' => getSetting('name_field_label', 'Full Name'),
    'email_field_label' => getSetting('email_field_label', 'Email Address'),
    'phone_field_label' => getSetting('phone_field_label', 'Phone Number'),
    'address_field_label' => getSetting('address_field_label', 'Payment Address'),
    'address_help_text' => getSetting('address_help_text', 'This is the address where you want to receive your funds.'),
    'back_button_text' => getSetting('back_button_text', 'Back'),
    'continue_step2_text' => getSetting('continue_step2_text', 'Continue'),
    
    // Step 3 - Confirmation Settings
    'confirmation_title' => getSetting('confirmation_title', 'Confirm Your Exchange'),
    'reference_id_title' => getSetting('reference_id_title', 'Exchange Reference ID'),
    'reference_id_message' => getSetting('reference_id_message', 'আপনার এক্সচেঞ্জ স্ট্যাটাস ট্র্যাক করার জন্য এই "Reference ID" সংরক্ষণ করে রাখুন। আমাদের সাথে যোগাযোগ করার সময় এটি প্রয়োজন হবে।'),
    'exchange_details_title' => getSetting('exchange_details_title', 'Exchange Details'),
    'payment_details_title' => getSetting('payment_details_title', 'Payment Details'),
    'payment_instruction' => getSetting('payment_instruction', 'আপনার লেনদেন শুরু করতে এই অ্যাকাউন্টে {amount} BDT/USD সেন্ড করুন:'),
    'after_payment_message' => getSetting('after_payment_message', 'পেমেন্ট পাঠানোর পর আপনার "Reference ID" নিয়ে WhatsApp-এ আমাদের অপারেটরের সাথে যোগাযোগ করুন।'),
    'next_steps_title' => getSetting('next_steps_title', 'Next Steps'),
    'whatsapp_contact_message' => getSetting('whatsapp_contact_message', 'আপনার এক্সচেঞ্জ অর্ডার সম্পন্ন করতে হোয়াটসঅ্যাপে আমাদের অপারেটরের সাথে যোগাযোগ করুন:'),
    'whatsapp_button_text' => getSetting('whatsapp_button_text', 'Contact Operator'),
    'final_instruction' => getSetting('final_instruction', 'যোগাযোগ করার সময় আপনার রেফারেন্স আইডি দিন এবং লেনদেন সম্পন্ন করতে অপারেটরের নির্দেশনা অনুসরণ করুন।'),
    'view_receipt_text' => getSetting('view_receipt_text', 'View Receipt'),
    'complete_button_text' => getSetting('complete_button_text', 'Complete'),
    'next_todo_text' => getSetting('next_todo_text', 'Next To Do'),
    
    // Form Labels
    'send_label_text' => getSetting('send_label_text', 'You Send:'),
    'receive_label_text' => getSetting('receive_label_text', 'You Receive:'),
    'rate_label_text' => getSetting('rate_label_text', 'Exchange Rate:'),
    'datetime_label_text' => getSetting('datetime_label_text', 'Date and Time:'),
    'status_label_text' => getSetting('status_label_text', 'Status:'),
    
    // Status Texts
    'pending_status' => getSetting('pending_status', 'Pending'),
    'confirmed_status' => getSetting('confirmed_status', 'Confirmed'),
    'cancelled_status' => getSetting('cancelled_status', 'Cancelled'),
    
    // Validation Messages
    'min_amount_error' => getSetting('min_amount_error', 'সর্বনিম্ন ৫ ডলার লেনদেন করতে হবে'),
    'invalid_email_error' => getSetting('invalid_email_error', 'দয়া করে সঠিক ই-মেইল ঠিকানা দিন'),
    'required_fields_error' => getSetting('required_fields_error', 'দয়া করে সব প্রয়োজনীয় ঘর পূরণ করুন'),
    'rate_unavailable_error' => getSetting('rate_unavailable_error', 'এই কারেন্সির জন্য এক্সচেঞ্জ রেট পাওয়া যাচ্ছে না'),
    
    // Success Messages
    'exchange_success_message' => getSetting('exchange_success_message', 'আপনার এক্সচেঞ্জ অর্ডার সফলভাবে জমা হয়েছে!'),
    'copy_success_message' => getSetting('copy_success_message', 'অ্যাকাউন্ট নাম্বার ক্লিপবোর্ডে কপি হয়েছে'),
    
    // Style Settings
    'wizard_font_family' => getSetting('wizard_font_family', 'hind_siliguri'),
    'wizard_primary_color' => getSetting('wizard_primary_color', '#5dffde'),
    'wizard_progress_bar_color' => getSetting('wizard_progress_bar_color', '#285FB7'),
    'wizard_border_radius' => getSetting('wizard_border_radius', 'medium'),
    
    // Feature Settings
    'enable_animations' => getSetting('enable_animations', 'yes'),
    'enable_sound_effects' => getSetting('enable_sound_effects', 'no'),
    'auto_save_progress' => getSetting('auto_save_progress', 'no')
];

// Set timezone
date_default_timezone_set(getSetting('site_timezone', 'Asia/Dhaka'));
?>

<!-- Success Message Alert -->
<div id="success-alert" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-100 border border-green-400 text-green-700 px-6 py-4 rounded-lg shadow-lg z-50 max-w-md w-full mx-4">
    <div class="flex items-center">
        <i class="fas fa-check-circle text-green-500 mr-3 text-xl"></i>
        <div class="flex-1">
            <div class="font-bold text-lg">Success!</div>
            <div id="success-message" class="text-sm"><?php echo htmlspecialchars($wizardSettings['exchange_success_message']); ?></div>
        </div>
        <button onclick="hideSuccessAlert()" class="ml-4 text-green-700 hover:text-green-900">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>

<!-- Exchange Wizard -->
<div id="exchange-wizard" class="mb-8">
    <!-- Step 1: Exchange Form -->
    <div id="step-1-exchange" class="exchange-step bg-white dark:bg-gray-800 rounded-lg shadow-card overflow-hidden mb-6 section-bg animated-border">
        <div class="bg-gray-50 dark:bg-gray-700 p-4 border-b border-gray-200 dark:border-gray-600">
            <div class="step-indicator">
                <div class="step active">
                    <div class="step-number">1</div>
                    <div class="step-title"><strong>Exchange Details</strong></div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-title"><strong>Contact Information</strong></div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-title"><strong>Confirmation</strong></div>
                </div>
            </div>
            
            <h2 class="text-xl font-bold text-center"><?php echo htmlspecialchars($wizardSettings['wizard_title']); ?></h2>
        </div>
        
        <div class="p-4 section-content">
            <div class="text-center mb-4 text-red-500 font-bold">
                <p><?php echo htmlspecialchars($wizardSettings['wizard_subtitle']); ?></p>
            </div>
            
            <h3 class="text-2xl font-bold text-center mb-6"><?php echo htmlspecialchars($wizardSettings['wizard_heading']); ?></h3>
            
            <div class="exchange-form-container max-w-md mx-auto">
                <form id="exchange-form" class="exchange-form-vertical">
                    <!-- SEND Section -->
                    <div class="exchange-form-section">
                        <div class="text-center mb-3">
                            <span class="inline-block px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 rounded-full font-bold">
                                <i class="fas fa-arrow-up text-blue-500 mr-1"></i> <?php echo htmlspecialchars($wizardSettings['send_section_label']); ?>
                            </span>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-bold mb-1 text-center"><?php echo htmlspecialchars($wizardSettings['currency_select_label']); ?></label>
                            <div class="custom-select-wrapper w-full" id="send-currency-wrapper">
                                <div class="custom-select border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
                                    <div class="custom-select__trigger p-3 flex justify-between items-center cursor-pointer">
                                        <div class="custom-select__selected-display flex items-center">
                                            <?php if (!empty($currencies)): ?>
                                                <?php $defaultCurrency = $currencies[0]; ?>
                                                <div class="payment-icon <?php echo $defaultCurrency['background_class'] ?: 'bg-pink-100 text-pink-500'; ?> w-7 h-7 mr-3">
                                                    <?php if ($defaultCurrency['logo']): ?>
                                                        <img src="<?php echo ASSETS_URL; ?>/uploads/currencies/<?php echo htmlspecialchars($defaultCurrency['logo']); ?>" alt="<?php echo htmlspecialchars($defaultCurrency['name']); ?>" class="w-full h-full object-contain">
                                                    <?php else: ?>
                                                        <i class="<?php echo $defaultCurrency['icon_class'] ?: 'fas fa-money-bill-wave'; ?> text-sm"></i>
                                                    <?php endif; ?>
                                                </div>
                                                <span class="custom-select__selected-value text-base font-bold" data-value="<?php echo $defaultCurrency['code']; ?>"><?php echo htmlspecialchars($defaultCurrency['name']); ?></span>
                                            <?php else: ?>
                                                <div class="payment-icon bg-pink-100 text-pink-500 w-7 h-7 mr-3">
                                                    <i class="fas fa-money-bill-wave text-sm"></i>
                                                </div>
                                                <span class="custom-select__selected-value text-base font-bold">Select Currency</span>
                                            <?php endif; ?>
                                        </div>
                                        <div class="arrow transition-transform duration-200">
                                            <i class="fas fa-chevron-down text-sm"></i>
                                        </div>
                                    </div>
                                    <div class="custom-options absolute z-20 hidden bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-b w-full mt-[-1px] currency-dropdown">
                                        <?php foreach ($currencies as $currency): ?>
                                            <div class="custom-option currency-option p-3 flex items-center hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer transition-all duration-150" data-value="<?php echo htmlspecialchars($currency['code']); ?>">
                                                <div class="payment-icon <?php echo $currency['background_class'] ?: 'bg-pink-100 text-pink-500'; ?> w-8 h-8 mr-3 flex-shrink-0">
                                                    <?php if ($currency['logo']): ?>
                                                        <img src="<?php echo ASSETS_URL; ?>/uploads/currencies/<?php echo htmlspecialchars($currency['logo']); ?>" alt="<?php echo htmlspecialchars($currency['name']); ?>" class="w-full h-full object-contain">
                                                    <?php else: ?>
                                                        <i class="<?php echo $currency['icon_class'] ?: 'fas fa-money-bill-wave'; ?> text-sm"></i>
                                                    <?php endif; ?>
                                                </div>
                                                <span class="currency-name text-base font-bold text-gray-800 dark:text-gray-200"><?php echo htmlspecialchars($currency['name']); ?></span>
                                            </div>
                                        <?php endforeach; ?>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold mb-1 text-center"><?php echo htmlspecialchars($wizardSettings['amount_input_label']); ?></label>
                            <input type="number" id="send-amount" name="sendAmount" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded p-3 amount-input text-center text-base font-semibold" placeholder="0.00" min="1" step="0.01" required>
                        </div>
                    </div>
                    
                    <!-- Exchange Direction Button - Fixed Position -->
                    <div class="exchange-direction-container">
                        <div class="exchange-direction-button" id="swap-currencies">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                    </div>
                    
                    <!-- RECEIVE Section -->
                    <div class="exchange-form-section">
                        <div class="text-center mb-3">
                            <span class="inline-block px-3 py-1 bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-300 rounded-full font-bold">
                                <i class="fas fa-arrow-down text-green-500 mr-1"></i> <?php echo htmlspecialchars($wizardSettings['receive_section_label']); ?>
                            </span>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-bold mb-1 text-center"><?php echo htmlspecialchars($wizardSettings['currency_select_label']); ?></label>
                            <div class="custom-select-wrapper w-full" id="receive-currency-wrapper">
                                <div class="custom-select border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
                                    <div class="custom-select__trigger p-3 flex justify-between items-center cursor-pointer">
                                        <div class="custom-select__selected-display flex items-center">
                                            <?php if (count($currencies) > 1): ?>
                                                <?php $secondCurrency = $currencies[1]; ?>
                                                <div class="payment-icon <?php echo $secondCurrency['background_class'] ?: 'bg-blue-500 text-white'; ?> w-7 h-7 mr-3">
                                                    <?php if ($secondCurrency['logo']): ?>
                                                        <img src="<?php echo ASSETS_URL; ?>/uploads/currencies/<?php echo htmlspecialchars($secondCurrency['logo']); ?>" alt="<?php echo htmlspecialchars($secondCurrency['name']); ?>" class="w-full h-full object-contain">
                                                    <?php else: ?>
                                                        <i class="<?php echo $secondCurrency['icon_class'] ?: 'fas fa-money-bill-wave'; ?> text-sm"></i>
                                                    <?php endif; ?>
                                                </div>
                                                <span class="custom-select__selected-value text-base font-bold" data-value="<?php echo $secondCurrency['code']; ?>"><?php echo htmlspecialchars($secondCurrency['name']); ?></span>
                                            <?php elseif (!empty($currencies)): ?>
                                                <div class="payment-icon bg-blue-500 text-white w-7 h-7 mr-3">
                                                    <i class="fas fa-money-bill-wave text-sm"></i>
                                                </div>
                                                <span class="custom-select__selected-value text-base font-bold" data-value="<?php echo $currencies[0]['code']; ?>"><?php echo htmlspecialchars($currencies[0]['name']); ?></span>
                                            <?php else: ?>
                                                <div class="payment-icon bg-blue-500 text-white w-7 h-7 mr-3">
                                                    <i class="fas fa-money-bill-wave text-sm"></i>
                                                </div>
                                                <span class="custom-select__selected-value text-base font-bold">Select Currency</span>
                                            <?php endif; ?>
                                        </div>
                                        <div class="arrow transition-transform duration-200">
                                            <i class="fas fa-chevron-down text-sm"></i>
                                        </div>
                                    </div>
                                    <div class="custom-options absolute z-20 hidden bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-b w-full mt-[-1px] currency-dropdown">
                                        <?php foreach ($currencies as $currency): ?>
                                            <div class="custom-option currency-option p-3 flex items-center hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer transition-all duration-150" data-value="<?php echo htmlspecialchars($currency['code']); ?>">
                                                <div class="payment-icon <?php echo $currency['background_class'] ?: 'bg-blue-500 text-white'; ?> w-8 h-8 mr-3 flex-shrink-0">
                                                    <?php if ($currency['logo']): ?>
                                                        <img src="<?php echo ASSETS_URL; ?>/uploads/currencies/<?php echo htmlspecialchars($currency['logo']); ?>" alt="<?php echo htmlspecialchars($currency['name']); ?>" class="w-full h-full object-contain">
                                                    <?php else: ?>
                                                        <i class="<?php echo $currency['icon_class'] ?: 'fas fa-money-bill-wave'; ?> text-sm"></i>
                                                    <?php endif; ?>
                                                </div>
                                                <span class="currency-name text-base font-bold text-gray-800 dark:text-gray-200"><?php echo htmlspecialchars($currency['name']); ?></span>
                                            </div>
                                        <?php endforeach; ?>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-bold mb-1 text-center"><?php echo htmlspecialchars($wizardSettings['receive_amount_label']); ?></label>
                            <input type="number" id="receive-amount" name="receiveAmount" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded p-3 amount-input text-center text-base font-semibold" placeholder="0.00" readonly>
                        </div>
                    </div>
                    
                    <!-- Exchange Rate Display -->
                    <div id="exchange-rate-display" class="exchange-rate-display font-semibold">
                        <i class="fas fa-chart-line mr-2"></i> Exchange Rate: Loading...
                    </div>
                    
                    <div class="text-center mt-4">
                        <button type="button" id="continue-to-step-2" class="exchange-btn px-6 py-3 rounded-full font-bold text-white shadow-md hover:shadow-lg">
                            <i class="fas fa-exchange-alt mr-2"></i> <?php echo htmlspecialchars($wizardSettings['continue_button_text']); ?>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="p-4 bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600">
            <div class="max-w-2xl mx-auto">
                <p class="text-sm text-gray-600 dark:text-gray-400 text-center font-medium">
                    <?php echo htmlspecialchars($wizardSettings['wizard_footer_text']); ?>
                </p>
            </div>
        </div>
    </div>
    
    <!-- Step 2: Contact Information -->
    <div id="step-2-contact" class="exchange-step bg-white dark:bg-gray-800 rounded-lg shadow-card overflow-hidden mb-6 section-bg animated-border" style="display: none;">
        <div class="bg-gray-50 dark:bg-gray-700 p-4 border-b border-gray-200 dark:border-gray-600">
            <div class="step-indicator">
                <div class="step completed">
                    <div class="step-number"><i class="fas fa-check"></i></div>
                    <div class="step-title"><strong>Exchange Details</strong></div>
                </div>
                <div class="step active">
                    <div class="step-number">2</div>
                    <div class="step-title"><strong>Contact Information</strong></div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-title"><strong>Confirmation</strong></div>
                </div>
            </div>
            
            <h2 class="text-xl font-bold text-center"><?php echo htmlspecialchars($wizardSettings['contact_step_title']); ?></h2>
        </div>
        
        <div class="p-6 section-content">
            <form id="contact-form" class="max-w-lg mx-auto">
                <div class="mb-4">
                    <label for="name" class="block text-sm font-bold mb-1 text-center"><?php echo htmlspecialchars($wizardSettings['name_field_label']); ?></label>
                    <input type="text" id="name" name="name" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded p-2 text-base text-center font-semibold" required>
                </div>
                
                <div class="mb-4">
                    <label for="email" class="block text-sm font-bold mb-1 text-center"><?php echo htmlspecialchars($wizardSettings['email_field_label']); ?></label>
                    <input type="email" id="email" name="email" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded p-2 text-base text-center font-semibold" required>
                </div>
                
                <div class="mb-4">
                    <label for="phone" class="block text-sm font-bold mb-1 text-center"><?php echo htmlspecialchars($wizardSettings['phone_field_label']); ?></label>
                    <input type="tel" id="phone" name="phone" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded p-2 text-base text-center font-semibold" required>
                </div>
                
                <div class="mb-4">
                    <label for="payment-address" class="block text-sm font-bold mb-1 text-center">
                        <span id="payment-address-label"><?php echo htmlspecialchars($wizardSettings['address_field_label']); ?></span>
                    </label>
                    <input type="text" id="payment-address" name="paymentAddress" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded p-2 text-base text-center font-semibold" required>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 text-center font-medium">
                        <?php echo htmlspecialchars($wizardSettings['address_help_text']); ?>
                    </p>
                </div>
                
                <div class="flex justify-between mt-6">
                    <button type="button" id="back-to-step-1" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors font-bold">
                        <i class="fas fa-arrow-left mr-2"></i> <?php echo htmlspecialchars($wizardSettings['back_button_text']); ?>
                    </button>
                    <button type="button" id="continue-to-step-3" class="exchange-btn px-6 py-2 rounded-full font-bold text-white shadow-md hover:shadow-lg">
                        <?php echo htmlspecialchars($wizardSettings['continue_step2_text']); ?> <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Step 3: Confirmation -->
    <div id="step-3-confirmation" class="exchange-step bg-white dark:bg-gray-800 rounded-lg shadow-card overflow-hidden mb-6 section-bg animated-border" style="display: none;">
        <div class="bg-gray-50 dark:bg-gray-700 p-4 border-b border-gray-200 dark:border-gray-600">
            <div class="step-indicator">
                <div class="step completed">
                    <div class="step-number"><i class="fas fa-check"></i></div>
                    <div class="step-title"><strong>Exchange Details</strong></div>
                </div>
                <div class="step completed">
                    <div class="step-number"><i class="fas fa-check"></i></div>
                    <div class="step-title"><strong>Contact Information</strong></div>
                </div>
                <div class="step active">
                    <div class="step-number">3</div>
                    <div class="step-title"><strong>Confirmation</strong></div>
                </div>
            </div>
            
            <h2 class="text-xl font-bold text-center"><?php echo htmlspecialchars($wizardSettings['confirmation_title']); ?></h2>
        </div>
        
        <div class="p-6 section-content">
            <div class="max-w-lg mx-auto">
                <!-- Reference ID Section -->
                <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg mb-6">
                    <div class="text-center mb-4">
                        <div class="text-lg font-bold text-blue-700 dark:text-blue-300"><?php echo htmlspecialchars($wizardSettings['reference_id_title']); ?></div>
                        <div id="reference-id" class="text-2xl font-bold text-blue-800 dark:text-blue-200">EB-25053101</div>
                    </div>
                    
                    <div class="text-sm text-blue-700 dark:text-blue-300 text-center font-medium">
                        <?php echo htmlspecialchars($wizardSettings['reference_id_message']); ?>
                    </div>
                </div>
                
                <!-- Exchange Details Section -->
                <div class="mb-6">
                    <h3 class="text-lg font-bold mb-3 text-center"><?php echo htmlspecialchars($wizardSettings['exchange_details_title']); ?></h3>
                    <div class="grid grid-cols-2 gap-4 border-b border-gray-200 dark:border-gray-700 pb-3 mb-3">
                        <div class="text-gray-600 dark:text-gray-400 font-semibold"><?php echo htmlspecialchars($wizardSettings['send_label_text']); ?></div>
                        <div id="confirm-send-amount" class="font-bold text-right">500.00 BDT</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 border-b border-gray-200 dark:border-gray-700 pb-3 mb-3">
                        <div class="text-gray-600 dark:text-gray-400 font-semibold"><?php echo htmlspecialchars($wizardSettings['receive_label_text']); ?></div>
                        <div id="confirm-receive-amount" class="font-bold text-right">5.00 USD</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 border-b border-gray-200 dark:border-gray-700 pb-3 mb-3">
                        <div class="text-gray-600 dark:text-gray-400 font-semibold"><?php echo htmlspecialchars($wizardSettings['rate_label_text']); ?></div>
                        <div id="confirm-rate" class="font-bold text-right">1 USD = 100 BDT</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 border-b border-gray-200 dark:border-gray-700 pb-3 mb-3">
                        <div class="text-gray-600 dark:text-gray-400 font-semibold"><?php echo htmlspecialchars($wizardSettings['datetime_label_text']); ?></div>
                        <div id="confirm-datetime" class="font-bold text-right">--/--/---- --:--:--</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-gray-600 dark:text-gray-400 font-semibold"><?php echo htmlspecialchars($wizardSettings['status_label_text']); ?></div>
                        <div class="font-bold text-right">
                            <span class="status-pending px-2 py-0.5 rounded text-xs font-bold">
                                <?php echo htmlspecialchars($wizardSettings['pending_status']); ?>
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- Complete Button - Moved here between Exchange Details and Payment Details -->
                <div class="text-center mb-6">
                    <button type="button" id="complete-exchange" class="exchange-btn px-8 py-3 rounded-full font-bold text-white shadow-md hover:shadow-lg text-lg">
                        <?php echo htmlspecialchars($wizardSettings['complete_button_text']); ?> <i class="fas fa-check ml-2"></i>
                    </button>
                </div>
                
                <!-- Next To Do Section - Added below Complete button -->
                <div class="text-center mb-6">
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent px-4 py-2 rounded-lg border-2 border-purple-200 bg-purple-50 dark:bg-purple-900/20 dark:border-purple-700">
                        <?php echo htmlspecialchars($wizardSettings['next_todo_text']); ?>
                    </h1>
                </div>
                
                <!-- Payment Details Section -->
                <div id="receiving-account-container" class="mb-6">
                    <h3 class="text-lg font-bold mb-3 text-center"><?php echo htmlspecialchars($wizardSettings['payment_details_title']); ?></h3>
                    <div class="bg-yellow-50 dark:bg-yellow-900 p-4 rounded-lg">
                        <p class="text-yellow-700 dark:text-yellow-300 mb-2 text-center font-semibold">
                            <?php 
                            $paymentText = str_replace('{amount}', '<span id="confirmation-amount" class="font-bold">500.00 BDT</span>', $wizardSettings['payment_instruction']);
                            echo $paymentText;
                            ?>
                        </p>
                        <div class="flex items-center bg-white dark:bg-gray-800 p-2 rounded mb-2">
                            <span id="account-text" class="flex-grow font-mono text-center font-bold"><a href="tel:01712345678">01712345678</a></span>
                            <button id="copy-account" type="button" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded ml-2 font-bold">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        <p class="text-sm text-yellow-600 dark:text-yellow-400 text-center font-medium">
                            <?php echo htmlspecialchars($wizardSettings['after_payment_message']); ?>
                        </p>
                    </div>
                </div>
                
                <!-- Next Steps Section -->
                <div class="mb-6">
                    <h3 class="text-lg font-bold mb-3 text-center"><?php echo htmlspecialchars($wizardSettings['next_steps_title']); ?></h3>
                    <div class="bg-yellow-50 dark:bg-yellow-900 p-4 rounded-lg">
                        <p class="text-yellow-700 dark:text-yellow-300 mb-3 text-center font-semibold">
                            <?php echo htmlspecialchars($wizardSettings['whatsapp_contact_message']); ?>
                        </p>
                        <a href="#" id="whatsapp-link" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded flex items-center justify-center font-bold">
                            <i class="fab fa-whatsapp text-xl mr-2"></i>
                            <?php echo htmlspecialchars($wizardSettings['whatsapp_button_text']); ?>: <?php echo htmlspecialchars($operatorContact['whatsapp']); ?>
                        </a>
                        <p class="text-xs text-yellow-600 dark:text-yellow-400 mt-2 text-center font-medium">
                            <?php echo htmlspecialchars($wizardSettings['final_instruction']); ?>
                        </p>
                    </div>
                </div>
                
                <!-- Navigation Buttons -->
                <div class="flex justify-between">
                    <button type="button" id="back-to-step-2" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors font-bold">
                        <i class="fas fa-arrow-left mr-2"></i> <?php echo htmlspecialchars($wizardSettings['back_button_text']); ?>
                    </button>
                    <button type="button" id="view-receipt-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded transition-colors font-bold">
                        <i class="fas fa-receipt mr-2"></i> <?php echo htmlspecialchars($wizardSettings['view_receipt_text']); ?>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Modal -->
<div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 max-w-4xl w-full mx-4 max-h-full overflow-y-auto rounded-lg">
        <div class="receipt-container" id="receipt-content">
            <!-- Receipt content will be dynamically generated here -->
        </div>
        <div class="p-4 border-t border-gray-200 dark:border-gray-600 text-center">
            <button id="download-receipt-pdf" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded mr-2 font-bold">
                <i class="fas fa-download mr-2"></i>Download PDF
            </button>
            <button id="print-receipt" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded mr-2 font-bold">
                <i class="fas fa-print mr-2"></i>Print
            </button>
            <button id="close-receipt-modal" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded font-bold">
                <i class="fas fa-times mr-2"></i>Close
            </button>
        </div>
    </div>
</div>

<style>
/* Apply custom font family from admin settings */
<?php
$fontFamily = $wizardSettings['wizard_font_family'];
$fontUrl = '';
switch($fontFamily) {
    case 'poppins':
        $fontUrl = '@import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap");';
        $fontStack = '"Poppins", sans-serif';
        break;
    case 'roboto':
        $fontUrl = '@import url("https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap");';
        $fontStack = '"Roboto", sans-serif';
        break;
    case 'hind_siliguri':
    default:
        $fontUrl = '@import url("https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap");';
        $fontStack = '"Hind Siliguri", sans-serif';
        break;
}
echo $fontUrl;
?>

/* Apply font family to exchange wizard */
#exchange-wizard {
    font-family: <?php echo $fontStack; ?>;
}

/* Custom CSS Variables from Admin Settings */
:root {
    --wizard-primary-color: <?php echo $wizardSettings['wizard_primary_color']; ?>;
    --wizard-progress-bar-color: <?php echo $wizardSettings['wizard_progress_bar_color']; ?>;
    <?php
    $borderRadius = $wizardSettings['wizard_border_radius'];
    switch($borderRadius) {
        case 'none':
            echo '--wizard-border-radius: 0;';
            break;
        case 'small':
            echo '--wizard-border-radius: 4px;';
            break;
        case 'large':
            echo '--wizard-border-radius: 12px;';
            break;
        case 'medium':
        default:
            echo '--wizard-border-radius: 8px;';
            break;
    }
    ?>
}

/* Exchange Step Display Control */
.exchange-step {
    transition: all 0.3s ease-in-out;
    border-radius: var(--wizard-border-radius);
}

/* Enhanced Custom Select Styling */
.custom-select {
    position: relative;
    border-radius: var(--wizard-border-radius);
}

.custom-select.open {
    z-index: 50;
}

.custom-select.open .custom-options {
    display: block !important;
    animation: dropdownSlideDown 0.3s ease-out;
    z-index: 51;
}

.custom-select.open .arrow {
    transform: rotate(180deg);
}

.custom-select__trigger {
    user-select: none;
    transition: all 0.2s ease;
    border-radius: var(--wizard-border-radius);
}

.custom-select__trigger:hover {
    background-color: #f9fafb;
    border-color: var(--wizard-primary-color);
}

.dark .custom-select__trigger:hover {
    background-color: #374151;
    border-color: var(--wizard-primary-color);
}

/* Enhanced Currency Dropdown */
.currency-dropdown {
    max-height: 420px;
    overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    border-radius: 0 0 var(--wizard-border-radius) var(--wizard-border-radius);
    scrollbar-width: thin;
    scrollbar-color: #CBD5E0 #F7FAFC;
    background-color: #FEFEFE !important;
    z-index: 51;
}

.dark .currency-dropdown {
    background-color: #1F2937 !important;
    scrollbar-color: #6B7280 #374151;
}

.currency-dropdown::-webkit-scrollbar {
    width: 6px;
}

.currency-dropdown::-webkit-scrollbar-track {
    background: #F7FAFC;
    border-radius: 3px;
}

.dark .currency-dropdown::-webkit-scrollbar-track {
    background: #374151;
}

.currency-dropdown::-webkit-scrollbar-thumb {
    background: #CBD5E0;
    border-radius: 3px;
}

.currency-dropdown::-webkit-scrollbar-thumb:hover {
    background: #A0AEC0;
}

.dark .currency-dropdown::-webkit-scrollbar-thumb {
    background: #6B7280;
}

.dark .currency-dropdown::-webkit-scrollbar-thumb:hover {
    background: #9CA3AF;
}

/* Enhanced Currency Option Styling */
.currency-option {
    min-height: 60px;
    border-bottom: 1px solid #F3F4F6;
    transition: all 0.15s ease-in-out;
    transform: translateX(0);
    background-color: #FEFEFE;
}

.dark .currency-option {
    border-bottom-color: #4B5563;
    background-color: #1F2937;
}

.currency-option:last-child {
    border-bottom: none;
}

.currency-option:hover {
    background-color: #F0F7FF !important;
    transform: translateX(4px);
    border-left: 3px solid var(--wizard-primary-color);
}

.dark .currency-option:hover {
    background-color: #2563EB !important;
    border-left-color: var(--wizard-primary-color);
}

/* Enhanced Currency Name Styling */
.currency-name {
    font-size: 1.1rem !important;
    font-weight: 700 !important;
    line-height: 1.4;
    transition: color 0.15s ease;
}

.currency-option:hover .currency-name {
    color: #1E3A8A !important;
}

.dark .currency-option:hover .currency-name {
    color: #DBEAFE !important;
}

/* Enhanced Selected Display */
.custom-select__selected-value {
    font-weight: 600 !important;
    font-size: 1rem !important;
    color: #1F2937;
}

.dark .custom-select__selected-value {
    color: #F9FAFB;
}

/* Enhanced Payment Icons */
.payment-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid rgba(255, 255, 255, 0.2);
    transition: all 0.15s ease;
}

.currency-option:hover .payment-icon {
    transform: scale(1.1);
    border-color: rgba(255, 255, 255, 0.4);
}

/* Dropdown Animation */
@keyframes dropdownSlideDown {
    from {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Exchange Form Styling with Fixed Arrow */
.exchange-form-container {
    position: relative;
}

.exchange-form-vertical {
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.exchange-form-section {
    position: relative;
    z-index: 1;
    background: white;
    padding: 1rem;
    border-radius: var(--wizard-border-radius);
    border: 1px solid #e5e7eb;
    transition: all 0.2s ease;
}

.exchange-form-section:has(.custom-select.open) {
    z-index: 45;
}

.exchange-form-section:hover {
    border-color: var(--wizard-primary-color);
    box-shadow: 0 2px 8px rgba(93, 92, 222, 0.1);
}

.dark .exchange-form-section {
    background: #1f2937;
    border-color: #374151;
}

.dark .exchange-form-section:hover {
    border-color: var(--wizard-primary-color);
    box-shadow: 0 2px 8px rgba(139, 138, 229, 0.1);
}

/* Exchange Direction Container - Fixed Position */
.exchange-direction-container {
    position: relative;
    height: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 5;
}

.exchange-direction-button {
    position: absolute;
    width: 44px;
    height: 44px;
    background-color: #fff;
    border: 2px solid #e5e7eb;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    top: 50%;
    transform: translateY(-50%);
}

.dark .exchange-direction-button {
    background-color: #1f2937;
    border-color: #4b5563;
    color: #fff;
}

.exchange-direction-button:hover {
    background-color: #f3f4f6;
    transform: translateY(-50%) scale(1.15);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
}

.dark .exchange-direction-button:hover {
    background-color: #374151;
}

.exchange-direction-button i {
    font-size: 18px;
    color: var(--wizard-primary-color);
}

.exchange-rate-display {
    text-align: center;
    padding: 0.75rem;
    background-color: #f9fafb;
    border-radius: var(--wizard-border-radius);
    margin-bottom: 1rem;
    font-size: 0.875rem;
    color: #4b5563;
    border: 1px solid #e5e7eb;
}

.dark .exchange-rate-display {
    background-color: #374151;
    color: #9ca3af;
    border-color: #4b5563;
}

.animate-spin {
    animation: spin 0.5s linear;
}

@keyframes spin {
    from { transform: translateY(-50%) rotate(0deg); }
    to { transform: translateY(-50%) rotate(360deg); }
}

/* Step Indicator */
.step-indicator {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    position: relative;
}

.step:not(:last-child):after {
    content: "";
    position: absolute;
    width: calc(100% - 30px);
    height: 2px;
    background-color: #e5e7eb;
    top: 12px;
    left: calc(50% + 15px);
}

.dark .step:not(:last-child):after {
    background-color: #4b5563;
}

.step-number {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: #e5e7eb;
    color: #6b7280;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    margin-bottom: 4px;
    z-index: 1;
}

.dark .step-number {
    background-color: #4b5563;
    color: #e5e7eb;
}

.step-title {
    font-size: 12px;
    color: #6b7280;
}

.dark .step-title {
    color: #9ca3af;
}

.step.active .step-number {
    background-color: var(--wizard-progress-bar-color);
    color: white;
}

.step.active .step-title {
    color: var(--wizard-progress-bar-color);
    font-weight: 600;
}

.step.completed .step-number {
    background-color: #10b981;
    color: white;
}

.step.completed .step-title {
    color: #10b981;
}

.dark .step.completed .step-title {
    color: #34d399;
}

.step.completed:not(:last-child):after {
    background-color: #10b981;
}

.step.active:not(:last-child):after {
    background-color: var(--wizard-progress-bar-color);
}

/* Status Badges */
.status-pending {
    background-color: #fef3c7;
    color: #92400e;
}

.dark .status-pending {
    background-color: #78350f;
    color: #fef3c7;
}

/* Animated Border */
.animated-border {
    position: relative;
    border-radius: var(--wizard-border-radius);
    overflow: hidden;
}

<?php if ($wizardSettings['enable_animations'] === 'yes'): ?>
.animated-border::before {
    content: '';
    position: absolute;
    inset: 0;
    z-index: -1;
    background: linear-gradient(
        90deg,
        rgba(93, 92, 222, 0.3),
        rgba(93, 92, 222, 0.1),
        rgba(93, 92, 222, 0.3)
    );
    background-size: 200% 100%;
    animation: shimmer 3s infinite;
    pointer-events: none;
}

@keyframes shimmer {
    0% { background-position: 100% 0; }
    100% { background-position: -100% 0; }
}
<?php endif; ?>

/* Exchange Button Styling */
.exchange-btn {
    background: linear-gradient(135deg, var(--wizard-primary-color) 0%, #4A4BC9 100%);
    transition: all 0.3s ease;
    border-radius: var(--wizard-border-radius);
}

.exchange-btn:hover {
    background: linear-gradient(135deg, #4A4BC9 0%, #3A3BB0 100%);
    transform: translateY(-1px);
}

/* Success Alert Animation */
.success-alert-show {
    animation: slideInFromTop 0.5s ease-out;
}

.success-alert-hide {
    animation: slideOutToTop 0.5s ease-in;
}

@keyframes slideInFromTop {
    from {
        opacity: 0;
        transform: translate(-50%, -100%);
    }
    to {
        opacity: 1;
        transform: translate(-50%, 0);
    }
}

@keyframes slideOutToTop {
    from {
        opacity: 1;
        transform: translate(-50%, 0);
    }
    to {
        opacity: 0;
        transform: translate(-50%, -100%);
    }
}

/* Receipt Modal Styling */
.receipt-container {
    width: 19cm;
    height: 13cm;
    background-color: #F8FAFF;
    box-shadow: 0 4px 25px rgba(0, 0, 0, 0.15);
    border-radius: 10px;
    overflow: hidden;
    position: relative;
    display: flex;
    flex-direction: column;
    margin: auto;
}

.receipt-header {
    padding: 15px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #0F2440;
    color: white;
}

.receipt-company-info {
    display: flex;
    align-items: center;
}

.receipt-logo {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: center;
    align-items: center;
    margin-right: 12px;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.receipt-logo i {
    color: #C6A44C;
    font-size: 20px;
}

.receipt-company-text {
    display: flex;
    flex-direction: column;
}

.receipt-company-name {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    font-weight: 700;
    color: white;
    letter-spacing: 0.5px;
}

.receipt-tagline {
    font-size: 11px;
    color: rgba(255, 255, 255, 0.7);
    font-weight: 400;
}

.receipt-transaction-details {
    text-align: left;
    padding: 10px 15px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    position: relative;
    overflow: hidden;
    border-left: 3px solid #C6A44C;
}

.receipt-transaction-id {
    font-weight: 700;
    color: white;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 5px;
}

.receipt-transaction-id i {
    color: #C6A44C;
}

.receipt-date-time {
    color: rgba(255, 255, 255, 0.8);
    font-size: 11px;
}

.receipt-date-time div {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 2px;
}

.receipt-date-time i {
    color: #C6A44C;
}

.receipt-main-content {
    flex: 1;
    padding: 15px 25px;
    display: flex;
    gap: 25px;
    position: relative;
    background: #EBF0F9;
}

.receipt-section {
    flex: 1;
    background: #1D3A5D;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    border: 1px solid rgba(255, 255, 255, 0.05);
    display: flex;
    flex-direction: column;
    color: white;
}

.receipt-section-title {
    font-size: 14px;
    font-weight: 700;
    color: white;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    gap: 8px;
}

.receipt-section-title i {
    color: #C6A44C;
}

.receipt-detail-row {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.receipt-detail-row i {
    color: #C6A44C;
    font-size: 12px;
    width: 16px;
    margin-right: 8px;
}

.receipt-detail-label {
    color: rgba(255, 255, 255, 0.7);
    font-weight: 600;
    margin-right: 8px;
    width: 60px;
    font-size: 12px;
}

.receipt-detail-value {
    font-weight: 500;
    color: white;
    flex: 1;
    font-size: 12px;
}

.receipt-detail-row.highlight {
    background: rgba(198, 164, 76, 0.1);
    padding: 6px 8px;
    border-radius: 6px;
    margin-left: -8px;
    margin-right: -8px;
    border-left: 3px solid #C6A44C;
}

.receipt-detail-row.highlight .receipt-detail-value {
    color: #C6A44C;
    font-weight: 700;
    font-size: 13px;
}

.receipt-footer {
    margin-top: auto;
}

.receipt-footer-content {
    padding: 12px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #0F2440;
    color: white;
}

.receipt-footer-section {
    display: flex;
    align-items: center;
    color: rgba(255, 255, 255, 0.9);
    font-size: 11px;
}

.receipt-footer-section i {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.1);
    color: #C6A44C;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-right: 10px;
    font-size: 12px;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.receipt-footer-title {
    font-size: 8px;
    color: #C6A44C;
    margin-bottom: 2px;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 600;
}

.receipt-footer-value {
    font-size: 11px;
    font-weight: 500;
}

.receipt-watermark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-30deg);
    font-family: 'Playfair Display', serif;
    font-size: 140px;
    font-weight: 800;
    color: rgba(198, 164, 76, 0.04);
    white-space: nowrap;
    z-index: 1;
    pointer-events: none;
}

/* Mobile Responsiveness */
@media (max-width: 640px) {
    .currency-dropdown {
        max-height: 360px;
    }
    
    .currency-option {
        min-height: 56px;
        padding: 0.75rem;
    }
    
    .currency-name {
        font-size: 1rem !important;
    }
    
    .payment-icon {
        width: 2rem;
        height: 2rem;
    }
    
    .custom-select__selected-display .payment-icon {
        width: 1.75rem;
        height: 1.75rem;
    }
    
    .receipt-container {
        width: 100%;
        height: auto;
        max-width: 95vw;
    }
    
    .receipt-main-content {
        flex-direction: column;
        gap: 15px;
    }
    
    .receipt-footer-content {
        flex-direction: column;
        gap: 10px;
    }
}

/* Focus States for Accessibility */
.custom-select__trigger:focus {
    outline: 2px solid var(--wizard-primary-color);
    outline-offset: 2px;
}

.currency-option:focus {
    outline: 2px solid var(--wizard-primary-color);
    outline-offset: -2px;
    background-color: #EBF4FF !important;
}

.dark .currency-option:focus {
    background-color: #3B82F6 !important;
}
</style>

<script>
// Initialize exchange rates from server
const exchangeRates = <?php echo json_encode($exchangeRatesJS); ?>;

// Initialize currencies data
const currencies = <?php echo json_encode($currencies); ?>;
const currencyInfo = {};
currencies.forEach(currency => {
    currencyInfo[currency.code] = {
        name: currency.name,
        displayName: currency.display_name || currency.code,
        paymentAddress: currency.payment_address || '',
        addressLabel: currency.address_label || 'Payment Address',
        addressType: currency.address_type || 'address'
    };
});

// Get wizard settings from server
const wizardSettings = <?php echo json_encode($wizardSettings); ?>;

// Get site info
const siteInfo = {
    name: '<?php echo htmlspecialchars($siteName); ?>',
    tagline: '<?php echo htmlspecialchars($siteTagline); ?>',
    email: '<?php echo htmlspecialchars($contactEmail); ?>',
    phone: '<?php echo htmlspecialchars($contactPhone); ?>',
    whatsapp: '<?php echo htmlspecialchars($operatorContact['whatsapp']); ?>'
};

// Debug logging
console.log('Exchange Rates:', exchangeRates);
console.log('Currencies:', currencies);
console.log('Currency Info:', currencyInfo);
console.log('Wizard Settings:', wizardSettings);

// Get official time from admin panel (server synchronized)
function getOfficialTime() {
    const adminTimeInput = document.getElementById('admin-current-time');
    if (adminTimeInput && adminTimeInput.value) {
        return adminTimeInput.value;
    }
    
    // Fallback: Calculate current time based on server timestamp
    const timestampInput = document.getElementById('admin-timestamp');
    if (timestampInput && timestampInput.value) {
        const serverTimestamp = parseInt(timestampInput.value) * 1000;
        const elapsedTime = Date.now() - serverTimestamp;
        const currentTime = new Date(serverTimestamp + elapsedTime);
        
        const year = currentTime.getFullYear();
        const month = (currentTime.getMonth() + 1).toString().padStart(2, '0');
        const day = currentTime.getDate().toString().padStart(2, '0');
        const hours = currentTime.getHours().toString().padStart(2, '0');
        const minutes = currentTime.getMinutes().toString().padStart(2, '0');
        const seconds = currentTime.getSeconds().toString().padStart(2, '0');
        
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }
    
    // Final fallback
    const now = new Date();
    const year = now.getFullYear();
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const day = now.getDate().toString().padStart(2, '0');
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const seconds = now.getSeconds().toString().padStart(2, '0');
    
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

// Get formatted date time for display
function getFormattedDateTime() {
    const officialTime = getOfficialTime();
    const date = new Date(officialTime);
    
    if (isNaN(date.getTime())) {
        // If date is invalid, return current time
        const now = new Date();
        const day = now.getDate().toString().padStart(2, '0');
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const year = now.getFullYear();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const seconds = now.getSeconds().toString().padStart(2, '0');
        
        return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
    }
    
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    const seconds = date.getSeconds().toString().padStart(2, '0');
    
    return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
}

// Generate sequential reference ID in EB-YYMMDDSS format
async function generateSequentialReferenceId() {
    try {
        const response = await fetch('api/generate_id.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'generate_exchange_id'
            })
        });
        
        const data = await response.json();
        if (data.success && data.exchange_id) {
            return data.exchange_id;
        } else {
            throw new Error(data.message || 'Failed to generate ID');
        }
    } catch (error) {
        console.error('Error generating reference ID:', error);
        
        // Fallback to client-side generation with proper date handling
        const officialTime = getOfficialTime();
        const date = new Date(officialTime);
        
        let year, month, day;
        
        if (isNaN(date.getTime())) {
            // If date is invalid, use current date
            const now = new Date();
            year = now.getFullYear().toString().slice(-2);
            month = (now.getMonth() + 1).toString().padStart(2, '0');
            day = now.getDate().toString().padStart(2, '0');
        } else {
            year = date.getFullYear().toString().slice(-2);
            month = (date.getMonth() + 1).toString().padStart(2, '0');
            day = date.getDate().toString().padStart(2, '0');
        }
        
        const random = Math.floor(Math.random() * 99) + 1;
        const randomStr = random.toString().padStart(2, '0');
        
        return `EB-${year}${month}${day}${randomStr}`;
    }
}

// Document ready function
document.addEventListener('DOMContentLoaded', function() {
    console.log('Document ready - initializing form...');
    
    // Initialize custom select dropdowns
    initializeCustomSelect();
    
    // Setup event listeners
    setupEventListeners();
    
    // Initialize calculation
    updateExchangeRate();
    
    // Update payment address label for initial selection
    updatePaymentAddressLabel();
    
    console.log('Form initialization complete');
});

// Initialize custom select dropdowns with enhanced functionality
function initializeCustomSelect() {
    console.log('Initializing custom select dropdowns...');
    
    // Toggle dropdown when trigger is clicked
    document.querySelectorAll('.custom-select__trigger').forEach(trigger => {
        trigger.addEventListener('click', function(e) {
            e.stopPropagation();
            const select = this.closest('.custom-select');
            closeAllSelects(select);
            select.classList.toggle('open');
            
            // Focus first option when opening
            if (select.classList.contains('open')) {
                const firstOption = select.querySelector('.custom-option');
                if (firstOption) {
                    firstOption.focus();
                }
            }
        });
        
        // Add keyboard support
        trigger.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });
    });
    
    // Handle option selection with enhanced animations
    document.querySelectorAll('.custom-option').forEach((option, index) => {
        option.addEventListener('click', function(e) {
            e.stopPropagation();
            const value = this.getAttribute('data-value');
            const select = this.closest('.custom-select');
            const trigger = select.querySelector('.custom-select__trigger');
            const selectedDisplay = trigger.querySelector('.custom-select__selected-display');
            
            // Add selection animation
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = '';
            }, 150);
            
            // Update the display with the selected option's content
            selectedDisplay.innerHTML = this.innerHTML;
            
            // Update the data-value attribute
            selectedDisplay.setAttribute('data-value', value);
            
            // Close the dropdown with animation
            select.classList.remove('open');
            
            // Special handling for receive currency
            if (select.closest('#receive-currency-wrapper')) {
                updatePaymentAddressLabel();
            }
            
            // Update exchange rate calculation
            updateExchangeRate();
        });
        
        // Add keyboard navigation
        option.setAttribute('tabindex', '0');
        option.addEventListener('keydown', function(e) {
            const select = this.closest('.custom-select');
            const options = Array.from(select.querySelectorAll('.custom-option'));
            const currentIndex = options.indexOf(this);
            
            switch (e.key) {
                case 'Enter':
                case ' ':
                    e.preventDefault();
                    this.click();
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    const nextIndex = Math.min(currentIndex + 1, options.length - 1);
                    options[nextIndex].focus();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    const prevIndex = Math.max(currentIndex - 1, 0);
                    options[prevIndex].focus();
                    break;
                case 'Escape':
                    select.classList.remove('open');
                    select.querySelector('.custom-select__trigger').focus();
                    break;
            }
        });
    });
    
    // Close all dropdowns when clicking outside
    document.addEventListener('click', function() {
        closeAllSelects();
    });
    
    // Close dropdowns on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAllSelects();
        }
    });
}

// Close all select dropdowns except the one passed
function closeAllSelects(exceptSelect) {
    document.querySelectorAll('.custom-select').forEach(select => {
        if (select !== exceptSelect) {
            select.classList.remove('open');
        }
    });
}

// Setup all event listeners
function setupEventListeners() {
    console.log('Setting up event listeners...');
    
    // Send amount input
    const sendAmountInput = document.getElementById('send-amount');
    if (sendAmountInput) {
        sendAmountInput.addEventListener('input', updateExchangeRate);
    }
    
    // Swap currencies button
    const swapButton = document.getElementById('swap-currencies');
    if (swapButton) {
        swapButton.addEventListener('click', swapCurrencies);
    }
    
    // Step navigation
    const continueStep2 = document.getElementById('continue-to-step-2');
    if (continueStep2) {
        continueStep2.addEventListener('click', goToStep2);
    }
    
    const backStep1 = document.getElementById('back-to-step-1');
    if (backStep1) {
        backStep1.addEventListener('click', goToStep1);
    }
    
    const continueStep3 = document.getElementById('continue-to-step-3');
    if (continueStep3) {
        continueStep3.addEventListener('click', goToStep3);
    }
    
    const backStep2 = document.getElementById('back-to-step-2');
    if (backStep2) {
        backStep2.addEventListener('click', goToStep2);
    }
    
    // Receipt button
    const receiptBtn = document.getElementById('view-receipt-btn');
    if (receiptBtn) {
        receiptBtn.addEventListener('click', viewReceipt);
    }
    
    // Complete exchange button
    const completeBtn = document.getElementById('complete-exchange');
    if (completeBtn) {
        completeBtn.addEventListener('click', completeExchange);
    }
    
    // Copy account button
    const copyBtn = document.getElementById('copy-account');
    if (copyBtn) {
        copyBtn.addEventListener('click', copyAccountToClipboard);
    }
    
    // Receipt modal buttons
    const closeReceiptModal = document.getElementById('close-receipt-modal');
    if (closeReceiptModal) {
        closeReceiptModal.addEventListener('click', hideReceiptModal);
    }
    
    const downloadReceiptPdf = document.getElementById('download-receipt-pdf');
    if (downloadReceiptPdf) {
        downloadReceiptPdf.addEventListener('click', downloadReceiptAsPDF);
    }
    
    const printReceipt = document.getElementById('print-receipt');
    if (printReceipt) {
        printReceipt.addEventListener('click', printReceiptContent);
    }
    
    console.log('Event listeners setup complete');
}

// Fixed showStep function - simplified and reliable
function showStep(stepNumber) {
    console.log(`Showing step ${stepNumber}...`);
    
    // Hide all steps first
    const allSteps = document.querySelectorAll('.exchange-step');
    allSteps.forEach(step => {
        step.style.display = 'none';
    });
    
    // Show the target step
    let targetStepId;
    switch(stepNumber) {
        case 1:
            targetStepId = 'step-1-exchange';
            break;
        case 2:
            targetStepId = 'step-2-contact';
            break;
        case 3:
            targetStepId = 'step-3-confirmation';
            break;
        default:
            console.error('Invalid step number:', stepNumber);
            return;
    }
    
    const targetStep = document.getElementById(targetStepId);
    if (targetStep) {
        targetStep.style.display = 'block';
        targetStep.style.opacity = '1';
        targetStep.style.transform = 'translateY(0)';
        console.log(`Successfully showed step ${stepNumber}`);
        
        // Scroll to top smoothly
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    } else {
        console.error(`Step element not found: ${targetStepId}`);
    }
}

// Get selected currency code
function getSelectedCurrency(wrapperId) {
    const wrapper = document.getElementById(wrapperId);
    if (!wrapper) {
        console.error(`Wrapper not found: ${wrapperId}`);
        return '';
    }
    
    const selectedValue = wrapper.querySelector('.custom-select__selected-display');
    if (!selectedValue) {
        console.error(`Selected display not found in wrapper: ${wrapperId}`);
        return '';
    }
    
    const value = selectedValue.getAttribute('data-value');
    console.log(`Selected currency for ${wrapperId}:`, value);
    return value || '';
}

// Update exchange rate calculation
function updateExchangeRate() {
    console.log('Updating exchange rate...');
    
    const sendAmount = parseFloat(document.getElementById('send-amount').value) || 0;
    const fromCurrency = getSelectedCurrency('send-currency-wrapper');
    const toCurrency = getSelectedCurrency('receive-currency-wrapper');
    
    console.log('Exchange calculation:', { sendAmount, fromCurrency, toCurrency });
    
    // Check if currencies are the same
    if (fromCurrency === toCurrency && fromCurrency && toCurrency) {
        console.log('Same currencies detected, finding alternative...');
        // Find a different currency to use
        const otherCurrency = currencies.find(c => c.code !== fromCurrency);
        if (otherCurrency) {
            // Auto-select the other currency
            const receiveCurrencyWrapper = document.getElementById('receive-currency-wrapper');
            const options = receiveCurrencyWrapper.querySelectorAll('.custom-option');
            
            for (let option of options) {
                if (option.getAttribute('data-value') === otherCurrency.code) {
                    const triggerDisplay = receiveCurrencyWrapper.querySelector('.custom-select__selected-display');
                    triggerDisplay.innerHTML = option.innerHTML;
                    triggerDisplay.setAttribute('data-value', otherCurrency.code);
                    updatePaymentAddressLabel();
                    console.log('Auto-selected different currency:', otherCurrency.code);
                    break;
                }
            }
        }
    }
    
    // Get the possibly updated to currency
    const updatedToCurrency = getSelectedCurrency('receive-currency-wrapper');
    
    // Look up the exchange rate
    const rateKey = `${fromCurrency}-${updatedToCurrency}`;
    let exchangeRate = exchangeRates[rateKey];
    
    console.log('Looking for rate:', rateKey, 'Found:', exchangeRate);
    
    // If direct rate not found, try inverse rate
    if (exchangeRate === undefined) {
        const inverseRateKey = `${updatedToCurrency}-${fromCurrency}`;
        const inverseRate = exchangeRates[inverseRateKey];
        
        console.log('Trying inverse rate:', inverseRateKey, 'Found:', inverseRate);
        
        if (inverseRate !== undefined && inverseRate !== 0) {
            exchangeRate = 1 / inverseRate;
            console.log('Using inverse rate:', exchangeRate);
        } else {
            exchangeRate = 0;
            console.log('No exchange rate found');
        }
    }
    
    // Calculate receive amount
    let receiveAmount = 0;
    if (exchangeRate > 0) {
        receiveAmount = sendAmount * exchangeRate;
    }
    
    console.log('Calculated receive amount:', receiveAmount);
    
    // Update receive amount input
    const receiveInput = document.getElementById('receive-amount');
    if (receiveInput) {
        receiveInput.value = receiveAmount.toFixed(2);
    }
    
    // Update exchange rate display
    updateExchangeRateDisplay(fromCurrency, updatedToCurrency, exchangeRate);
}

// Update exchange rate display
function updateExchangeRateDisplay(fromCurrency, toCurrency, rate) {
    const displayElement = document.getElementById('exchange-rate-display');
    if (!displayElement) return;
    
    if (!fromCurrency || !toCurrency || rate === 0 || rate === undefined) {
        displayElement.innerHTML = `<i class="fas fa-exclamation-triangle mr-2 text-yellow-500"></i> ${wizardSettings.rate_unavailable_error}`;
        return;
    }
    
    const fromName = currencyInfo[fromCurrency]?.displayName || fromCurrency;
    const toName = currencyInfo[toCurrency]?.displayName || toCurrency;
    
    displayElement.innerHTML = `<i class="fas fa-chart-line mr-2"></i> ${wizardSettings.rate_label_text} 1 ${fromName} = ${rate.toFixed(4)} ${toName}`;
}

// Swap currencies with enhanced animation
function swapCurrencies() {
    console.log('Swapping currencies...');
    
    // Get current selected values
    const sendWrapper = document.getElementById('send-currency-wrapper');
    const receiveWrapper = document.getElementById('receive-currency-wrapper');
    
    const sendDisplay = sendWrapper.querySelector('.custom-select__selected-display');
    const receiveDisplay = receiveWrapper.querySelector('.custom-select__selected-display');
    
    // Store the current HTML and values
    const sendHTML = sendDisplay.innerHTML;
    const sendValue = sendDisplay.getAttribute('data-value');
    const receiveHTML = receiveDisplay.innerHTML;
    const receiveValue = receiveDisplay.getAttribute('data-value');
    
    // Swap values
    sendDisplay.innerHTML = receiveHTML;
    sendDisplay.setAttribute('data-value', receiveValue);
    receiveDisplay.innerHTML = sendHTML;
    receiveDisplay.setAttribute('data-value', sendValue);
    
    // Update payment address label
    updatePaymentAddressLabel();
    
    // Update exchange rate
    updateExchangeRate();
    
    console.log('Currency swap complete');
}

// Update payment address label based on selected receive currency
function updatePaymentAddressLabel() {
    const toCurrency = getSelectedCurrency('receive-currency-wrapper');
    const addressLabel = document.getElementById('payment-address-label');
    const addressType = document.getElementById('payment-address-type');
    
    if (toCurrency && currencyInfo[toCurrency]) {
        if (addressLabel) addressLabel.textContent = currencyInfo[toCurrency].addressLabel || wizardSettings.address_field_label;
        if (addressType) addressType.textContent = currencyInfo[toCurrency].addressType || 'address';
    } else {
        if (addressLabel) addressLabel.textContent = wizardSettings.address_field_label;
        if (addressType) addressType.textContent = 'address';
    }
}

// Go to step 2
function goToStep2() {
    console.log('Attempting to go to step 2...');
    
    try {
        // Validate step 1
        const sendAmountInput = document.getElementById('send-amount');
        if (!sendAmountInput) {
            console.error('Send amount input not found');
            showToast('Error', 'Form error: Amount input not found', 'error');
            return;
        }
        
        const sendAmount = parseFloat(sendAmountInput.value) || 0;
        console.log('Send amount:', sendAmount);
        
        if (sendAmount < 1) {
            console.log('Amount validation failed');
            showToast('Error', wizardSettings.min_amount_error, 'error');
            return;
        }
        
        // Check for valid exchange rate
        const fromCurrency = getSelectedCurrency('send-currency-wrapper');
        const toCurrency = getSelectedCurrency('receive-currency-wrapper');
        
        console.log('Currency validation:', { fromCurrency, toCurrency });
        
        if (!fromCurrency || !toCurrency) {
            console.log('Currency selection validation failed');
            showToast('Error', 'Please select both currencies', 'error');
            return;
        }
        
        const rateKey = `${fromCurrency}-${toCurrency}`;
        const inverseRateKey = `${toCurrency}-${fromCurrency}`;
        
        console.log('Checking exchange rates:', { rateKey, inverseRateKey });
        console.log('Available rates:', exchangeRates);
        
        if (!exchangeRates[rateKey] && !exchangeRates[inverseRateKey]) {
            console.log('Exchange rate validation failed');
            showToast('Error', wizardSettings.rate_unavailable_error, 'error');
            return;
        }
        
        console.log('All validations passed, proceeding to step 2');
        
        // Show step 2
        showStep(2);
        
    } catch (error) {
        console.error('Error in goToStep2:', error);
        showToast('Error', 'An error occurred while processing your request', 'error');
    }
}

// Go back to step 1
function goToStep1() {
    console.log('Going back to step 1');
    showStep(1);
}

// Go to step 3
async function goToStep3() {
    console.log('Attempting to go to step 3...');
    
    try {
        // Validate step 2
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const paymentAddress = document.getElementById('payment-address').value;
        
        console.log('Contact form validation:', { name, email, phone, paymentAddress });
        
        if (!name || !email || !phone || !paymentAddress) {
            showToast('Error', wizardSettings.required_fields_error, 'error');
            return;
        }
        
        // Email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showToast('Error', wizardSettings.invalid_email_error, 'error');
            return;
        }
        
        // Generate sequential reference ID
        const referenceId = await generateSequentialReferenceId();
        document.getElementById('reference-id').textContent = referenceId;
        
        // Update confirmation details
        updateConfirmationDetails();
        
        // Show step 3
        showStep(3);
        
    } catch (error) {
        console.error('Error in goToStep3:', error);
        showToast('Error', 'An error occurred while processing your request', 'error');
    }
}

// Go back to step 2
function goToStep2() {
    console.log('Going back to step 2');
    showStep(2);
}

// Update confirmation details
function updateConfirmationDetails() {
    console.log('Updating confirmation details...');
    
    const fromCurrency = getSelectedCurrency('send-currency-wrapper');
    const toCurrency = getSelectedCurrency('receive-currency-wrapper');
    
    const fromName = currencyInfo[fromCurrency]?.displayName || fromCurrency;
    const toName = currencyInfo[toCurrency]?.displayName || toCurrency;
    
    const sendAmount = parseFloat(document.getElementById('send-amount').value);
    const receiveAmount = parseFloat(document.getElementById('receive-amount').value);
    
    // Update confirmation texts
    document.getElementById('confirm-send-amount').textContent = `${sendAmount.toFixed(2)} ${fromName}`;
    document.getElementById('confirm-receive-amount').textContent = `${receiveAmount.toFixed(2)} ${toName}`;
    document.getElementById('confirmation-amount').textContent = `${sendAmount.toFixed(2)} ${fromName}`;
    
    // Set date and time from admin panel
    const formattedDateTime = getFormattedDateTime();
    document.getElementById('confirm-datetime').textContent = formattedDateTime;
    
    // Set exchange rate
    const rateKey = `${fromCurrency}-${toCurrency}`;
    let rate = exchangeRates[rateKey];
    
    if (rate === undefined) {
        const inverseRateKey = `${toCurrency}-${fromCurrency}`;
        const inverseRate = exchangeRates[inverseRateKey];
        
        if (inverseRate !== undefined && inverseRate !== 0) {
            rate = 1 / inverseRate;
            document.getElementById('confirm-rate').textContent = `1 ${fromName} = ${rate.toFixed(4)} ${toName}`;
        } else {
            document.getElementById('confirm-rate').textContent = 'Rate not available';
        }
    } else {
        document.getElementById('confirm-rate').textContent = `1 ${fromName} = ${rate.toFixed(4)} ${toName}`;
    }
    
    // Set payment account
    if (currencyInfo[fromCurrency] && currencyInfo[fromCurrency].paymentAddress) {
        document.getElementById('account-text').textContent = currencyInfo[fromCurrency].paymentAddress;
        
        // Make it clickable if it's a phone number
        if (/^\d+$/.test(currencyInfo[fromCurrency].paymentAddress)) {
            document.getElementById('account-text').innerHTML = `<a href="tel:${currencyInfo[fromCurrency].paymentAddress}">${currencyInfo[fromCurrency].paymentAddress}</a>`;
        }
    } else {
        const defaultAccount = '<?php echo htmlspecialchars(getSetting('default_payment_address', '01712345678')); ?>';
        document.getElementById('account-text').textContent = defaultAccount;
        
        // Make it clickable if it's a phone number
        if (/^\d+$/.test(defaultAccount)) {
            document.getElementById('account-text').innerHTML = `<a href="tel:${defaultAccount}">${defaultAccount}</a>`;
        }
    }
    
    // Update WhatsApp link
    const whatsappMessage = createWhatsAppMessage();
    document.getElementById('whatsapp-link').href = `https://wa.me/${siteInfo.whatsapp.replace(/[^0-9]/g, '')}?text=${whatsappMessage}`;
}

// Create WhatsApp message with exchange details
function createWhatsAppMessage() {
    const referenceId = document.getElementById('reference-id').textContent;
    const name = document.getElementById('name').value || 'Customer';
    const email = document.getElementById('email').value || 'N/A';
    const phone = document.getElementById('phone').value || 'N/A';
    const paymentAddress = document.getElementById('payment-address').value || 'N/A';
    
    const fromCurrency = getSelectedCurrency('send-currency-wrapper');
    const toCurrency = getSelectedCurrency('receive-currency-wrapper');
    
    const sendAmount = document.getElementById('send-amount').value;
    const receiveAmount = document.getElementById('receive-amount').value;
    
    const fromName = currencyInfo[fromCurrency]?.name || fromCurrency;
    const toName = currencyInfo[toCurrency]?.name || toCurrency;
    
    const message = `Hello ${siteInfo.name} Operator,
My Transaction ID: ${referenceId}
Name: ${name}
E-mail: ${email}
Phone: ${phone}
Receiving Address: ${paymentAddress}
${fromName} ${sendAmount} ${fromCurrency} to ${toName} ${receiveAmount} ${toCurrency}
Time: ${getOfficialTime()}`;

    return encodeURIComponent(message);
}

// View receipt
function viewReceipt() {
    generateReceiptModal();
}

// Generate receipt modal content
function generateReceiptModal() {
    const referenceId = document.getElementById('reference-id').textContent;
    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;
    const phone = document.getElementById('phone').value;
    const paymentAddress = document.getElementById('payment-address').value;
    
    const fromCurrency = getSelectedCurrency('send-currency-wrapper');
    const toCurrency = getSelectedCurrency('receive-currency-wrapper');
    
    const fromName = currencyInfo[fromCurrency]?.name || fromCurrency;
    const toName = currencyInfo[toCurrency]?.name || toCurrency;
    
    const sendAmount = parseFloat(document.getElementById('send-amount').value);
    const receiveAmount = parseFloat(document.getElementById('receive-amount').value);
    
    // Get exchange rate
    const rateKey = `${fromCurrency}-${toCurrency}`;
    let rate = exchangeRates[rateKey];
    
    if (rate === undefined) {
        const inverseRateKey = `${toCurrency}-${fromCurrency}`;
        const inverseRate = exchangeRates[inverseRateKey];
        
        if (inverseRate !== undefined && inverseRate !== 0) {
            rate = 1 / inverseRate;
        } else {
            rate = 0;
        }
    }
    
    const formattedDateTime = getFormattedDateTime();
    const dateTimeParts = formattedDateTime.split(' ');
    const datePart = dateTimeParts[0];
    const timePart = dateTimeParts[1];
    
    const receiptHTML = `
        <div class="receipt-watermark">EXCHANGE</div>
        
        <div class="receipt-header">
            <div class="receipt-company-info">
                <div class="receipt-logo">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div class="receipt-company-text">
                    <div class="receipt-company-name">${siteInfo.name}</div>
                    <div class="receipt-tagline">${siteInfo.tagline}</div>
                </div>
            </div>
            
            <div class="receipt-transaction-details">
                <div class="receipt-transaction-id">
                    <i class="fas fa-fingerprint"></i>
                    <span>${referenceId}</span>
                </div>
                <div class="receipt-date-time">
                    <div>
                        <i class="far fa-calendar-alt"></i>
                        <span>${datePart}</span>
                    </div>
                    <div>
                        <i class="far fa-clock"></i>
                        <span>${timePart}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="receipt-main-content">
            <div class="receipt-section">
                <div class="receipt-section-title">
                    <i class="fas fa-user-circle"></i> Customer Details
                </div>
                <div class="receipt-detail-row">
                    <i class="fas fa-user"></i>
                    <span class="receipt-detail-label">Name:</span>
                    <span class="receipt-detail-value">${name}</span>
                </div>
                ${email ? `
                <div class="receipt-detail-row">
                    <i class="fas fa-envelope"></i>
                    <span class="receipt-detail-label">Email:</span>
                    <span class="receipt-detail-value">${email}</span>
                </div>
                ` : ''}
                ${phone ? `
                <div class="receipt-detail-row">
                    <i class="fas fa-phone"></i>
                    <span class="receipt-detail-label">Phone:</span>
                    <span class="receipt-detail-value">${phone}</span>
                </div>
                ` : ''}
                <div class="receipt-detail-row">
                    <i class="fas fa-map-marker-alt"></i>
                    <span class="receipt-detail-label">Address:</span>
                    <span class="receipt-detail-value">${paymentAddress}</span>
                </div>
            </div>
            
            <div class="receipt-section">
                <div class="receipt-section-title">
                    <i class="fas fa-money-bill-wave"></i> Exchange Details
                </div>
                <div class="receipt-detail-row">
                    <i class="fas fa-exchange-alt"></i>
                    <span class="receipt-detail-label">From:</span>
                    <span class="receipt-detail-value">${fromName} ${fromCurrency}</span>
                </div>
                <div class="receipt-detail-row">
                    <i class="fas fa-exchange-alt"></i>
                    <span class="receipt-detail-label">To:</span>
                    <span class="receipt-detail-value">${toName} ${toCurrency}</span>
                </div>
                <div class="receipt-detail-row">
                    <i class="fas fa-exchange-alt"></i>
                    <span class="receipt-detail-label">Rate:</span>
                    <span class="receipt-detail-value">${rate.toFixed(2)} ${toCurrency}/${fromCurrency}</span>
                </div>
                <div class="receipt-detail-row highlight">
                    <i class="fas fa-dollar-sign"></i>
                    <span class="receipt-detail-label">Sent:</span>
                    <span class="receipt-detail-value">${sendAmount.toFixed(2)} ${fromCurrency}</span>
                </div>
                <div class="receipt-detail-row highlight">
                    <i class="fas fa-hand-holding-usd"></i>
                    <span class="receipt-detail-label">Received:</span>
                    <span class="receipt-detail-value">${receiveAmount.toFixed(2)} ${toCurrency}</span>
                </div>
            </div>
        </div>
        
        <div class="receipt-footer">
            <div class="receipt-footer-content">
                <div class="receipt-footer-section">
                    <i class="fas fa-globe"></i>
                    <div>
                        <div class="receipt-footer-title">Website</div>
                        <div class="receipt-footer-value">${window.location.hostname}</div>
                    </div>
                </div>
                <div class="receipt-footer-section">
                    <i class="fas fa-envelope"></i>
                    <div>
                        <div class="receipt-footer-title">Email Address</div>
                        <div class="receipt-footer-value">${siteInfo.email}</div>
                    </div>
                </div>
                <div class="receipt-footer-section">
                    <i class="fas fa-phone-alt"></i>
                    <div>
                        <div class="receipt-footer-title">Contact Number</div>
                        <div class="receipt-footer-value">${siteInfo.phone}</div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('receipt-content').innerHTML = receiptHTML;
    document.getElementById('receipt-modal').classList.remove('hidden');
}

// Hide receipt modal
function hideReceiptModal() {
    document.getElementById('receipt-modal').classList.add('hidden');
}

// Download receipt as PDF
function downloadReceiptAsPDF() {
    const element = document.getElementById('receipt-content');
    const opt = {
        margin: 0,
        filename: `${siteInfo.name}_Receipt_${document.getElementById('reference-id').textContent}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, logging: false },
        jsPDF: { unit: 'cm', format: [19, 13], orientation: 'landscape' }
    };
    
    // Generate PDF
    html2pdf().set(opt).from(element).save();
}

// Print receipt content
function printReceiptContent() {
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Receipt - ${document.getElementById('reference-id').textContent}</title>
            <style>
                ${document.querySelector('style').innerHTML}
                body { margin: 0; padding: 20px; background: white; }
                .receipt-container { box-shadow: none; }
            </style>
        </head>
        <body>
            <div class="receipt-container">
                ${document.getElementById('receipt-content').innerHTML}
            </div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// Complete exchange
function completeExchange() {
    console.log('Completing exchange...');
    
    // Show loading state
    const completeBtn = document.getElementById('complete-exchange');
    const originalBtnText = completeBtn.innerHTML;
    completeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
    completeBtn.disabled = true;
    
    // Prepare form data
    const formData = new FormData();
    formData.append('reference_id', document.getElementById('reference-id').textContent);
    formData.append('customer_name', document.getElementById('name').value);
    formData.append('customer_email', document.getElementById('email').value);
    formData.append('customer_phone', document.getElementById('phone').value);
    formData.append('payment_address', document.getElementById('payment-address').value);
    formData.append('from_currency', getSelectedCurrency('send-currency-wrapper'));
    formData.append('to_currency', getSelectedCurrency('receive-currency-wrapper'));
    formData.append('send_amount', document.getElementById('send-amount').value);
    formData.append('receive_amount', document.getElementById('receive-amount').value);
    formData.append('exchange_datetime', getOfficialTime());
    
    // Get the exchange rate
    const fromCurrency = getSelectedCurrency('send-currency-wrapper');
    const toCurrency = getSelectedCurrency('receive-currency-wrapper');
    const rateKey = `${fromCurrency}-${toCurrency}`;
    let rate = exchangeRates[rateKey];
    
    if (rate === undefined) {
        const inverseRateKey = `${toCurrency}-${fromCurrency}`;
        const inverseRate = exchangeRates[inverseRateKey];
        
        if (inverseRate !== undefined && inverseRate !== 0) {
            rate = 1 / inverseRate;
        } else {
            rate = 0;
        }
    }
    
    formData.append('exchange_rate', rate);
    
    // Submit the form
    fetch('api/exchange.php', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessAlert();
            
            // Restore button state
            completeBtn.innerHTML = originalBtnText;
            completeBtn.disabled = false;
            
            // Keep the form on step 3 - do not redirect or reset
        } else {
            showToast('Error', data.message || 'Failed to submit exchange', 'error');
            completeBtn.innerHTML = originalBtnText;
            completeBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error', 'An error occurred while processing your request', 'error');
        completeBtn.innerHTML = originalBtnText;
        completeBtn.disabled = false;
    });
}

// Show success alert
function showSuccessAlert() {
    const alert = document.getElementById('success-alert');
    alert.classList.remove('hidden');
    alert.classList.add('success-alert-show');
    
    // Auto hide after 10 seconds
    setTimeout(() => {
        hideSuccessAlert();
    }, 10000);
}

// Hide success alert
function hideSuccessAlert() {
    const alert = document.getElementById('success-alert');
    alert.classList.add('success-alert-hide');
    
    setTimeout(() => {
        alert.classList.add('hidden');
        alert.classList.remove('success-alert-show', 'success-alert-hide');
    }, 500);
}

// Copy account to clipboard
function copyAccountToClipboard() {
    const accountText = document.getElementById('account-text').textContent;
    
    navigator.clipboard.writeText(accountText)
        .then(() => {
            showToast('Success', wizardSettings.copy_success_message, 'success');
        })
        .catch(err => {
            // Fallback for browsers that don't support clipboard API
            const textarea = document.createElement('textarea');
            textarea.value = accountText;
            textarea.style.position = 'fixed';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('Success', wizardSettings.copy_success_message, 'success');
                } else {
                    showToast('Error', 'Failed to copy account details', 'error');
                }
            } catch (err) {
                showToast('Error', 'Failed to copy account details', 'error');
            }
            
            document.body.removeChild(textarea);
        });
}

// Show toast notification with enhanced styling
function showToast(title, message, type = 'info', duration = 5000) {
    console.log(`Toast: ${type} - ${title}: ${message}`);
    
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'fixed bottom-4 right-4 z-50 flex flex-col space-y-2';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast toast-${type} flex items-center p-4 rounded-lg shadow-lg transform transition-all duration-300 ease-out`;
    
    // Set icon based on type
    let iconClass = 'fa-info-circle';
    if (type === 'success') iconClass = 'fa-check-circle';
    if (type === 'error') iconClass = 'fa-exclamation-circle';
    if (type === 'warning') iconClass = 'fa-exclamation-triangle';
    
    // Set background and text color based on type
    let bgColor = 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 border-blue-200';
    if (type === 'success') bgColor = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 border-green-200';
    if (type === 'error') bgColor = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 border-red-200';
    if (type === 'warning') bgColor = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 border-yellow-200';
    
    toast.className += ` ${bgColor} border`;
    
    // Set toast content
    toast.innerHTML = `
        <div class="mr-3">
            <i class="fas ${iconClass} text-lg"></i>
        </div>
        <div class="flex-1">
            <div class="font-bold text-sm">${title}</div>
            <div class="text-sm opacity-90 font-medium">${message}</div>
        </div>
        <button class="ml-3 text-current opacity-70 hover:opacity-100 transition-opacity">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Initially hide the toast for animation
    toast.style.transform = 'translateX(100%) scale(0.8)';
    toast.style.opacity = '0';
    
    // Add toast to container
    toastContainer.appendChild(toast);
    
    // Trigger animation
    setTimeout(() => {
        toast.style.transform = 'translateX(0) scale(1)';
        toast.style.opacity = '1';
    }, 10);
    
    // Add click handler to close button
    const closeButton = toast.querySelector('button');
    closeButton.addEventListener('click', () => {
        removeToast(toast);
    });
    
    // Auto remove after duration
    setTimeout(() => {
        removeToast(toast);
    }, duration);
    
    function removeToast(toastElement) {
        if (toastElement.parentNode) {
            toastElement.style.opacity = '0';
            toastElement.style.transform = 'translateX(100%) scale(0.8)';
            
            setTimeout(() => {
                if (toastElement.parentNode) {
                    toastElement.remove();
                }
            }, 300);
        }
    }
}
</script>